<!DOCTYPE html>
<html lang="en-us">

	<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      มาลองสร้าง Serverless App บน AWS Lambda กัน &middot; Coladev.com
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/public/js/hightlightjs/styles/tomorrow.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
<script src="http://127.0.0.1:35729/livereload.js"></script></head>


	<body>

		<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <img src="/assets/images/coladev-logo-light.png">
    <h3>COLADEV.COM</h3>
    <p>บันทึกและบทความเกี่ยวกับการเขียนโปรแกรมจากโปรแกรมเมอร์น้อยๆผู้ชื่นชอบโค้กเป็นชีวิตจิตใจ</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>
    <a class="sidebar-nav-item" href="/tags/javascripts">Javascripts</a>
    <a class="sidebar-nav-item" href="/tags/devops">Devops</a>
  </nav>
</div>


		<!-- Wrap is the content to shift when toggling the sidebar. We wrap the
				 content to avoid any CSS collisions with our real content. -->
		<div class="wrap">
			<div class="masthead">
				<div class="container">
					<div class="masthead-title">
						<a href="/" title="Coladev.com">
							<img src="/assets/images/logo.png">
						</a>
					</div>
				</div>
			</div>

			<div class="container content">
				<div class="post">
	<img src="/assets/images/thumbnail/lambda.png">
	<h1 class="post-title">มาลองสร้าง Serverless App บน AWS Lambda กัน</h1>
	<span class="post-date">16 Jan 2017</span>
	<p>    Serverless เป็นเทรนใหม่ในการทำ Backend Application ในยุคปัจจุบันที่สามารถสร้างและขยายปริมาณการรองรับการใช้งานได้อย่างง่ายดาย และบน AWS Lambda นั่น สามารถช่วยให้เราทำ Serverless Application ในการจัดการข้อมูล รวมไปถึง API สำหรับแอพลิเคชันหน้าบ้านได้โดยแทบไม่ต้องใช้ความรู้ในการ setup และ deploy แอพในรูปแบบของเซิฟเวอร์แบบเดิมเลยทีเดียว เพียงแค่เขียนโปรแกรมให้ได้ตามที่ต้องการก็เพียงพอแล้ว</p>

<hr />

<p>    ในยุคปัจจุบันนั้นการ การดีพลอยเว็บใช้วิธีการรันไว้บนเซิฟเวอร์ทั่วไป ซึ่งจำเป็นต้องรันไว้ตลอดเวลาเพื่อให้สามารถเข้าถึงได้ตลอดเวลานั่นเอง เมื่อต้องรันไว้ตลอดเวลา ก็ต้องมีเซิฟเวอร์รันค้างไว้ ถึงแม้จะไม่มีการเข้าใช้งานก็ตาม แต่ก็ยังใช้ทรัพยากรนั่นไปเรื่อยๆอยู่ดี</p>

<p>แต่วันนี้เรามีแนวทางการทำเว็บใหม่มานำเสนอ นั่นก็คือ</p>

<h2 id="serverless-application">Serverless Application</h2>

<p>ชื่อก็บอกอยู่แล้วนะ Serverless ก็คือ ไม่จำเป็นต้องมีเซิฟเวอร์รันอยู่ตลอดเวลา โดยแอพที่เรารันนั้นจะรันเฉพาะเมื่อมี event ในการเรียกใช้งานเข้ามาเท่านั้น เช่น มีการเรียก HTTP Request เข้ามา หรือ มีค่าอัพเดตทาง DB แล้ว trigger เข้ามารันใช้งานแอพ ซึ่งแน่นอนว่าวิธีการเขียน การออกแบบ และการดีพลอยแอพ ก็จะแตกต่างออกไปจากเดิมค่อนข้างมากเลยทีเดียว ซึ่งทาง AWS ก็มีเครื่องมือ ตัวนึงที่จะมาใช้ให้เราสามารถสร้าง serverless application ได้ง่ายๆ บน aws เอง โดยมีชื่อว่า</p>

<h2 id="aws-lambda">AWS Lambda</h2>

<p>AWS Lambda เป็นเครื่องมือที่ไว้ใช้สำหรับสร้างและรัน Serverless Application บน AWS ครับ โดยเจ้า Lambda เองเป็นเครื่องกลางในการผนวก service อื่นๆของอเมซอนเข้ามาใช้ในการรันแอพลิเคชัน มาดูกันก่อนว่าจริงๆแล้ว ตัว AWS Lambda เอง มันประกอบไปด้วยอะไรบ้าง และสามารถเชื่อมต่อกับ service อื่นๆตัวไหนของ aws ได้อีกบ้าง</p>

<h3 id="architecture">Architecture</h3>

<p>การรันโปรแกรมบน AWS Lambda นั้น ตัว Lambda จะแปลงโค้ดที่เราจะต้องการรัน หรือเรียกสั่งๆว่าเป็น <code class="highlighter-rouge">Lambda Function</code> เป็น Container เมื่อมีการรันโปรแกรมผ่านช่องทางที่เราผูก event ไว้ ตัว lambda เองก็จะรันตัวโปรแกรมนั้นให้เราจบๆไปเป็น event และเมื่อไม่มีการเรียกใช้งานก็จะอยู่ในสถานะ freeze ตัวเอง หรือไม่ได้รันเซิฟเวอร์อยู่นั่นเอง</p>

<p><img src="/assets/images/posts/lambda/lambda-architect.png" alt="AWS Lambda Architecture for Web Application" /></p>

<p>ยกตัวอย่างการทำเว็บแอพลิเคชันเชื่อมต่อกับ AWS Lambda ซึ่งทำตัวเป็น API ตัวนึง ก็จะเกิดการรันก็ต่อเมื่อมี Request เข้ามาที่ตัวระบบ</p>

<h3 id="lambda-function">Lambda Function</h3>

<p>การเขียนโปรแกรมบน AWS Lambda นั้นจะเป็น Functional Programming โดยเขียนเฉพาะฟังก์ชันเที่เราต้องการจะรันในการเกิด Event แต่ละครั้ง โดยเราสามารถเขียนบนภาษาที่ Lambda รองรับได้ คือ <code class="highlighter-rouge">Node.js</code> <code class="highlighter-rouge">C#</code> <code class="highlighter-rouge">Java</code> <code class="highlighter-rouge">Python</code></p>

<h3 id="event-driven">Event Driven</h3>

<p>การรัน Lambda Function ที่เราเขียนไว้นั้น จะเกิดขึ้นก็ต่อเมื่อมี Event มาทำการสั่งรันตัวฟังก์ชัน ซึ่งมีด้วยกันหลาย trigger โดยแบ่งเป็น 2 แบบหลักๆคือ</p>

<ul>
  <li>Streaming Event</li>
</ul>

<p>เป็นอีเวนท์ที่เข้ามาตลอดเวลาในช่วงระยะเวลาหนึ่งๆ เช่น ดึงข้อมูลจาก social network เป็นต้น โดยอีเวนท์นี้สามารถที่จะเชื่อมต่อกับเซอร์วิสของ AWS 2 ตัว คือ</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- DynamoDB Streaming
- AWS Kinesis
</code></pre>
</div>

<ul>
  <li>Non-Streaming Event</li>
</ul>

<p>เป็นอีเวนท์ปกติที่สามารถ trigger ขึ้นมาด้วย action บางอย่าง เช่น การเรียก HTTP Request / IoT Event เป็นต้น โดยสามารถเชื่อมต่อกับ AWS Services ได้ดังนี้</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- API Gateway 	สำหรับสร้าง API ให้สามารถเรียกได้ผ่าน HTTP Request
- AWS IoT
- Cloudfront
- Cloudwatch
- S3
- SNS
</code></pre>
</div>

<p><img src="/assets/images/posts/lambda/lambda-photo.png" alt="AWS Lambda S3" /></p>

<p>ยกตัวอย่างการใช้งานรวมกับ S3 เมื่อมีรูปถูกอัพโหลดขึ้นมาที่ S3 ก็จะมี Event ตัวนึงไป trigger เพื่อรัน lambda function ไปทำการ resize รูป</p>

<h2 id="hello-world-api-with-nodejs">Hello World API with Node.js</h2>

<p>สำหรับท่านที่ยังไม่มีสมัคร account aws กันก่อนนะครับ จากนั้นไปที่ Console &gt; AWS Lambda แล้วเราก็จะมาเริ่มทำการสร้าง Lambda Function กันก่อนนะครับ</p>

<p><img src="/assets/images/posts/lambda/lambda-blueprint.png" alt="AWS Lambda S3" /></p>

<p>ในส่วนของการสร้างจะมี Blueprint ให้เราเลือกค่อนข้างเยอะ แต่ในบทความนี้เราจะมาดูตัวที่ง่ายที่สุดก่อนละกัน เลือกไปที่ <code class="highlighter-rouge">hello-world</code> เลยครับ</p>

<p><img src="/assets/images/posts/lambda/lambda-trigger.png" alt="AWS Lambda Trigger" /></p>

<p>จากนั้นเราก็จะมาตั้งค่าตัว trigger สำหรับ invoke lambda function ตัวนี้นะครับ โดยในตอนนี้จะมาสร้าง API สำหรับให้เรียกใช้ได้ผ่าน Http Request นะครับ ซึ่ง AWS ก็จะมีเครื่องมือที่เรียกว่า <code class="highlighter-rouge">API Gateway</code></p>

<p><img src="/assets/images/posts/lambda/lambda-api-gateway.png" alt="AWS Lambda + API Gateway" /></p>

<p>เมื่อเราเลือก API Gateway จากนั้นเราก็จะมาคอนฟิคตัว API กันนะครับ โดยมี 3 Option ให้เลือก</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- API name 			// Group Service
- Deployment Stage		// Stage
- Security
</code></pre>
</div>

<p>โดย Security จะมีให้เลือกอยู่ 3 option ตั้งเชื่อ API name และ deployment stage ได้ตามสะดวก</p>

<div class="highlighter-rouge"><pre class="highlight"><code>- AWS IAM
- Open
- Open with access key
</code></pre>
</div>

<p>ในบทความนี้เราจะทำ API ที่เป็น Public ก่อน ดังนั้นเลือก Open เลยครับ</p>

<p><img src="/assets/images/posts/lambda/lambda-function-detail.png" alt="AWS Lambda Function Detail" /></p>

<p>จากนั้นเราก็จะมา config ตัว lambda function และเขียนโค้ด lambda function กันนะครับ ก็ตั้งชื่อและเลือก Runtime เลย โดยในที่นี้ผมจะใช้ Node.js ในการรัน ซึ่งเวอร์ชันที่ Lambda ใช้จะเป็น Node 4.3 และในการเขียนโค้ดก็มีวิธีการใช้ดึงมาโค้ดมาใช้ได้หลายแบบ เช่น เขียนบนเว็บ อัพโหลดไฟล์ หรือดึงมาจาก S3 แน่นอนว่าตัวอย่างนี้แนะนำวิธีที่ง่ายที่สุดคือ เขียนบน AWS Console เลย โดยผมเลือก option เป็น default ทั้งหมดเลย</p>

<p>การตั้งชื่อ API name / deployment stage และ function name จะมีผลกับ url ของ API Gateway ที่เราจะเรียกใช้ service นี้เช่นกัน โดยเราจะได้ url ออกมาในรูปแบบ</p>

<div class="highlighter-rouge"><pre class="highlight"><code>http://url/[API NAME]/[DEPLOYMENT STAGE]/[FUNCTION NAME]
</code></pre>
</div>

<p>จากนั้นก็กดสร้างก็จะได้ Lambda Function ไว้ช้งานเรียบร้อย</p>

<p><img src="/assets/images/posts/lambda/lambda-edit-response-console.png" alt="AWS Lambda Function" /></p>

<p>มาดูในส่วนของโค้ดฟังก์ชันกันก่อนนะครับ</p>

<div class="highlighter-rouge"><pre class="highlight"><code>'use strict';

console.log('Loading function');

exports.handler = (event, context, callback) =&gt; {
    //console.log('Received event:', JSON.stringify(event, null, 2));
    console.log('value1 =', event.key1);
    console.log('value2 =', event.key2);
    console.log('value3 =', event.key3);
    callback(null, event.key1);  // Echo back the first key value
    //callback('Something went wrong');
};
</code></pre>
</div>

<p>Lambda Function บน Node.js นั้นเราจะมีฟังก์ชันหลักโดยจะมี parameter อยู่ 3 ตัว ส่ง response กลับไปด้วยฟังก์ชัน callback และหากเราจะส่ง response ผ่านทาง <code class="highlighter-rouge">API Gateway</code> เราก็ต้องมาดูกันก่อนว่า API Gateway นั้นรับพารามิเตอร์อะไรบ้าง เพื่อให้เราสามารถเขียน response ของ lambda function ให้ถูกฟอร์แมตของตัว API Gateway กันนะครับ ไม่อย่างนั้นจะไม่สามารถส่ง response กลับไปที่บราวเซอร์ได้ถูกต้องนะครับ</p>

<p>ฟอร์แมต Response ไปที่ตัว API Gateway ต้องเป็นประมานนี้</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"statusCode"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">		</span><span class="err">//</span><span class="w"> </span><span class="err">HTTP</span><span class="w"> </span><span class="err">Status</span><span class="w">
  </span><span class="nt">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">		</span><span class="err">//</span><span class="w"> </span><span class="err">Header</span><span class="w">
  </span><span class="nt">"body"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">		</span><span class="err">//String</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>จากนั้นเราก็เขียน callback ให้ส่ง response กลับในรูปแบบนี้นะครับ</p>

<div class="highlighter-rouge"><pre class="highlight"><code>'use strict';

exports.handler = (event, context, callback) =&gt; {
	var str = "Hello World";

	callback(null, {
		"statusCode": 200,
		"headers": {},
		"body": str
	});
};
</code></pre>
</div>

<p>ทีนี้มาลองรับค่า parameter โดยรับค่าผ่านตัวแปร <code class="highlighter-rouge">event</code> แล้วส่งค่าเป็น json response กลับไปผ่าน header <code class="highlighter-rouge">Content-Type</code> กันนะครับ</p>

<div class="highlighter-rouge"><pre class="highlight"><code>'use strict';

exports.handler = (event, context, callback) =&gt; {
	var a = parseInt(event.a);
	var b = parseInt(event.b);

	var sum = parseInt();
	var response = {
		equation: a + " + " + b,
		sum: a + b
	}

	callback(null, {
		"statusCode": 200,
		"headers": {
			"Content-Type": "application/json"
		},
		"body": JSON.stringify(response)
	});
};
</code></pre>
</div>

<h2 id="api-gateway">API Gateway</h2>


</div>

<div class="author">
	<h4>Author</h4>
	<div class="profile">
		<div class="img"></div>
		<div class="info">
			<h4>Anonymous</h4>
			<p>Web Developer</p>
			<p>Nextzy Technology Co,. LTD.</p>
		</div>
	</div>
</div>

<div class="related">
	<h2>Related</h2>
	<div class="ralated-posts">
	
		<a href="/javascripts/framework/2017/02/09/js101">
		<div class="post">
			<img src="/assets/images/thumbnail/js101.png">
			<h2 class="post-title">
					JS Basic: EP1. พื้นฐานแบบเน้นๆ
			</h2>

			<span class="post-date">ปูพื้นฐาน javascripts ใหม่กันเถอะ</span>
		</div>
	</a>
	
		<a href="/javascripts/framework/2017/01/16/robot-framework">
		<div class="post">
			<img src="/assets/images/thumbnail/js101.png">
			<h2 class="post-title">
					VirtualDOM
			</h2>

			<span class="post-date">มารู้จัก VirtualDOM ใน HTML5 กัน</span>
		</div>
	</a>
	
		<a href="/javascripts/framework/2017/01/16/regression-test">
		<div class="post">
			<img src="/assets/images/thumbnail/js101.png">
			<h2 class="post-title">
					CSS Automate Test: Regression
			</h2>

			<span class="post-date">เทส CSS แบบ Automate บน PhantomJS</span>
		</div>
	</a>
	
	</div>
</div>

<div class="comments">
	<div id="disqus_thread"></div>
	<script>
	
	var disqus_developer = 1;
	var disqus_config = function () {
		this.page.identifier = "/aws/nodejs/2017/01/16/aws-lambda-101";
	};
	
	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = '//coladev.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
</div>
			</div>
			<footer class="footer">
	<div class="container">
		&copy; Coladev.com 2017. All rights reserved.
	</div>
</footer>
		</div>
		

		<label for="sidebar-checkbox" class="sidebar-toggle"></label>

		<script src="/assets/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/assets/js/highlight.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/assets/js/app.js" type="text/javascript" charset="utf-8"></script>

		<script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-35966443-7', 'auto');
			ga('send', 'pageview');

		</script>
	</body>
</html>
